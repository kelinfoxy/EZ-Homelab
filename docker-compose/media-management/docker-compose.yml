# Media Management Services
# Content automation and library management (*arr apps, transcoders, etc.)
# Place in /opt/stacks/media-management/docker-compose.yml

# RESTART POLICY GUIDE:
# - unless-stopped: Core infrastructure services that should always run
# - no: Services with Sablier lazy loading (start on-demand)
# - See individual service comments for specific reasoning

# Service Access URLs:
# - Sonarr: https://sonarr.${DOMAIN}
# - Radarr: https://radarr.${DOMAIN}
# - Prowlarr: https://prowlarr.${DOMAIN}
# - Readarr: https://readarr.${DOMAIN}
# - Lidarr: https://lidarr.${DOMAIN}
# - LazyLibrarian: https://lazylibrarian.${DOMAIN}
# - Mylar3: https://mylar.${DOMAIN}
# - Jellyseerr: https://jellyseerr.${DOMAIN}
# - Tdarr: https://tdarr.${DOMAIN}
# - Unmanic: https://unmanic.${DOMAIN}

services:
  # Sonarr - TV show automation
  # Access at: https://sonarr.yourdomain.duckdns.org
  sonarr:
    image: linuxserver/sonarr:4.0.0
    container_name: sonarr
    restart: unless-stopped
    networks:
      - media-network
      - homelab-network
      - traefik-network
    volumes:
      - ./sonarr/config:/config
      - /mnt/media:/media
      - /mnt/downloads:/downloads # Large downloads on separate drive
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    labels:
      - homelab.category=media
      - homelab.description=TV show management and automation
      # Traefik labels with Authelia
      - traefik.enable=true
      - traefik.http.routers.sonarr.rule=Host(`sonarr.${DOMAIN}`)
      - traefik.http.routers.sonarr.entrypoints=websecure
      - traefik.http.routers.sonarr.tls.certresolver=letsencrypt
      - traefik.http.routers.sonarr.middlewares=authelia@docker
      - traefik.http.services.sonarr.loadbalancer.server.port=8989
  # Radarr - Movie automation
  # Access at: https://radarr.yourdomain.duckdns.org
  radarr:
    image: linuxserver/radarr:5.2.6
    container_name: radarr
    restart: unless-stopped
    networks:
      - media-network
      - homelab-network
      - traefik-network
    volumes:
      - ./radarr/config:/config
      - /mnt/media:/media
      - /mnt/downloads:/downloads # Large downloads on separate drive
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    labels:
      - homelab.category=media
      - homelab.description=Movie management and automation
      # Traefik labels with Authelia
      - traefik.enable=true
      - traefik.http.routers.radarr.rule=Host(`radarr.${DOMAIN}`)
      - traefik.http.routers.radarr.entrypoints=websecure
      - traefik.http.routers.radarr.tls.certresolver=letsencrypt
      - traefik.http.routers.radarr.middlewares=authelia@docker
      - traefik.http.services.radarr.loadbalancer.server.port=7878
  # Prowlarr - Indexer manager
  # Access at: https://prowlarr.yourdomain.duckdns.org
  prowlarr:
    image: linuxserver/prowlarr:1.11.4
    container_name: prowlarr
    restart: unless-stopped
    networks:
      - media-network
      - homelab-network
      - traefik-network
    volumes:
      - ./prowlarr/config:/config
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    labels:
      - homelab.category=media
      - homelab.description=Indexer manager for Sonarr/Radarr
      # Traefik labels with Authelia
      - traefik.enable=true
      - traefik.http.routers.prowlarr.rule=Host(`prowlarr.${DOMAIN}`)
      - traefik.http.routers.prowlarr.entrypoints=websecure
      - traefik.http.routers.prowlarr.tls.certresolver=letsencrypt
      - traefik.http.routers.prowlarr.middlewares=authelia@docker
      - traefik.http.services.prowlarr.loadbalancer.server.port=9696
  # Readarr - Ebook and audiobook management
  # Access at: https://readarr.${DOMAIN}
  readarr:
    image: linuxserver/readarr:0.4.19-nightly
    container_name: readarr
    restart: unless-stopped
    networks:
      - media-network
      - homelab-network
      - traefik-network
    volumes:
      - ./readarr/config:/config
      - /mnt/media/books:/books
      - /mnt/downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
    labels:
      - homelab.category=media
      - homelab.description=Ebook and audiobook management
      - traefik.enable=true
      - traefik.http.routers.readarr.rule=Host(`readarr.${DOMAIN}`)
      - traefik.http.routers.readarr.entrypoints=websecure
      - traefik.http.routers.readarr.tls.certresolver=letsencrypt
      - traefik.http.routers.readarr.middlewares=authelia@docker
      - traefik.http.services.readarr.loadbalancer.server.port=8787
  # Lidarr - Music collection manager
  # Access at: https://lidarr.${DOMAIN}
  lidarr:
    image: linuxserver/lidarr:2.0.7
    container_name: lidarr
    restart: unless-stopped
    networks:
      - media-network
      - homelab-network
      - traefik-network
    volumes:
      - ./lidarr/config:/config
      - /mnt/media/music:/music
      - /mnt/downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
    labels:
      - homelab.category=media
      - homelab.description=Music collection manager
      - traefik.enable=true
      - traefik.http.routers.lidarr.rule=Host(`lidarr.${DOMAIN}`)
      - traefik.http.routers.lidarr.entrypoints=websecure
      - traefik.http.routers.lidarr.tls.certresolver=letsencrypt
      - traefik.http.routers.lidarr.middlewares=authelia@docker
      - traefik.http.services.lidarr.loadbalancer.server.port=8686
  # Lazy Librarian - Book manager
  # Access at: https://lazylibrarian.${DOMAIN}
  lazylibrarian:
    image: linuxserver/lazylibrarian:latest
    container_name: lazylibrarian
    restart: unless-stopped
    networks:
      - media-network
      - homelab-network
      - traefik-network
    volumes:
      - ./lazylibrarian/config:/config
      - /mnt/media/books:/books
      - /mnt/downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
      - DOCKER_MODS=linuxserver/mods:lazylibrarian-ffmpeg
    labels:
      - homelab.category=media
      - homelab.description=Book download automation
      - traefik.enable=true
      - traefik.http.routers.lazylibrarian.rule=Host(`lazylibrarian.${DOMAIN}`)
      - traefik.http.routers.lazylibrarian.entrypoints=websecure
      - traefik.http.routers.lazylibrarian.tls.certresolver=letsencrypt
      - traefik.http.routers.lazylibrarian.middlewares=authelia@docker
      - traefik.http.services.lazylibrarian.loadbalancer.server.port=5299
  # Mylar3 - Comic book manager
  # Access at: https://mylar.${DOMAIN}
  mylar3:
    image: linuxserver/mylar3:latest
    container_name: mylar3
    restart: unless-stopped
    networks:
      - media-network
      - homelab-network
      - traefik-network
    volumes:
      - ./mylar3/config:/config
      - /mnt/media/comics:/comics
      - /mnt/downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
    labels:
      - homelab.category=media
      - homelab.description=Comic book collection manager
      - traefik.enable=true
      - traefik.http.routers.mylar.rule=Host(`mylar.${DOMAIN}`)
      - traefik.http.routers.mylar.entrypoints=websecure
      - traefik.http.routers.mylar.tls.certresolver=letsencrypt
      - traefik.http.routers.mylar.middlewares=authelia@docker
      - traefik.http.services.mylar.loadbalancer.server.port=8090
  # Jellyseerr - Request management for Jellyfin/Plex
  # Access at: https://jellyseerr.${DOMAIN}
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    restart: unless-stopped
    networks:
      - media-network
      - homelab-network
      - traefik-network
    volumes:
      - ./jellyseerr/config:/app/config
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ}
    labels:
      - homelab.category=media
      - homelab.description=Media request management
      - traefik.enable=true
      - traefik.http.routers.jellyseerr.rule=Host(`jellyseerr.${DOMAIN}`)
      - traefik.http.routers.jellyseerr.entrypoints=websecure
      - traefik.http.routers.jellyseerr.tls.certresolver=letsencrypt
      - traefik.http.routers.jellyseerr.middlewares=authelia@docker
      - traefik.http.services.jellyseerr.loadbalancer.server.port=5055
      - "x-dockge.url=https://jellyseerr.${DOMAIN}"
      - "x-dockge.url=https://jellyseerr.${DOMAIN}"
  # FlareSolverr - Cloudflare bypass for Prowlarr
  # No web UI - used by Prowlarr
  flaresolverr:
    image: flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    networks:
      - media-network
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ}
    labels:
      - homelab.category=media
      - homelab.description=Cloudflare bypass for indexers
  # Tdarr Server - Distributed transcoding server
  # Access at: https://tdarr.${DOMAIN}
  tdarr-server:
    image: ghcr.io/haveagitgat/tdarr:latest
    container_name: tdarr-server
    restart: unless-stopped
    networks:
      - media-network
      - homelab-network
      - traefik-network
    ports:
      - 8266:8266 # Server port
    volumes:
      - ./tdarr/server:/app/server
      - ./tdarr/configs:/app/configs
      - ./tdarr/logs:/app/logs
      - /mnt/media:/media
      - /mnt/tdarr-transcode:/temp # Transcode cache on separate drive
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
      - serverIP=0.0.0.0
      - serverPort=8266
      - webUIPort=8265
    labels:
      - homelab.category=media
      - homelab.description=Distributed transcoding server
      - traefik.enable=true
      - traefik.http.routers.tdarr.rule=Host(`tdarr.${DOMAIN}`)
      - traefik.http.routers.tdarr.entrypoints=websecure
      - traefik.http.routers.tdarr.tls.certresolver=letsencrypt
      - traefik.http.routers.tdarr.middlewares=authelia@docker
      - traefik.http.services.tdarr.loadbalancer.server.port=8265
  # Tdarr Node - Transcoding worker
  # No web UI - controlled by server
  tdarr-node:
    image: ghcr.io/haveagitgat/tdarr_node:latest
    container_name: tdarr-node
    restart: unless-stopped
    networks:
      - media-network
    volumes:
      - ./tdarr/configs:/app/configs
      - ./tdarr/logs:/app/logs
      - /mnt/media:/media
      - /mnt/tdarr-transcode:/temp
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
      - nodeID=MainNode
      - nodeIP=0.0.0.0
      - nodePort=8267
      - serverIP=tdarr-server
      - serverPort=8266
    labels:
      - homelab.category=media
      - homelab.description=Tdarr transcoding worker node
  # Unmanic - Another transcoding option
  # Access at: https://unmanic.${DOMAIN}
  unmanic:
    image: josh5/unmanic:latest
    container_name: unmanic
    restart: unless-stopped
    networks:
      - media-network
      - homelab-network
      - traefik-network
    volumes:
      - ./unmanic/config:/config
      - /mnt/media:/library
      - /mnt/unmanic-cache:/tmp/unmanic # Transcode cache on separate drive
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ}
    labels:
      - homelab.category=media
      - homelab.description=Library optimization and transcoding
      - traefik.enable=true
      - traefik.http.routers.unmanic.rule=Host(`unmanic.${DOMAIN}`)
      - traefik.http.routers.unmanic.entrypoints=websecure
      - traefik.http.routers.unmanic.tls.certresolver=letsencrypt
      - traefik.http.routers.unmanic.middlewares=authelia@docker
      - traefik.http.services.unmanic.loadbalancer.server.port=8888
networks:
  media-network:
    external: true
  homelab-network:
    external: true
  traefik-network:
    external: true
