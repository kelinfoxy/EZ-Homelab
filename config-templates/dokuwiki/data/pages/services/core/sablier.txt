====== Sablier ======

Sablier is a lazy loading service that starts Docker containers on-demand when accessed, then automatically stops them after a period of inactivity. This saves system resources by keeping unused services stopped until needed.

===== Overview =====

**Purpose:** On-demand container startup
**Integration:** Traefik middleware
**Resource Savings:** Significant CPU/memory reduction
**Deployment:** Core stack (always running)
**Configuration:** Label-based activation

===== Key Features =====

**Lazy Loading:**
  * **On-Demand Startup**: Containers start when accessed
  * **Automatic Shutdown**: Stop after inactivity timeout
  * **Resource Efficiency**: Save CPU/memory when not used
  * **Transparent**: No user experience changes

**Integration:**
  * **Traefik Middleware**: HTTP request triggering
  * **Label Configuration**: Simple Docker labels
  * **Group Management**: Related services as groups
  * **Health Checks**: Wait for service readiness

**Performance:**
  * **Fast Startup**: Quick container initialization
  * **Timeout Control**: Configurable inactivity periods
  * **Queue Management**: Handle multiple concurrent requests
  * **Monitoring**: Startup/shutdown tracking

===== Configuration =====

**Container Configuration:**
```yaml
services:
  sablier:
    image: acouvreur/sablier:latest
    container_name: sablier
    restart: unless-stopped
    environment:
      - SABLIER_STRATEGY=docker-api
      - SABLIER_DOCKER_API_VERSION=1.41
      - SABLIER_DOCKER_NETWORK=traefik-network
      - SABLIER_TIMEOUT=5m
      - SABLIER_SESSION_DURATION=168h
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik-network
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
```

**Service Integration Labels:**
```yaml
# Enable Sablier for a service
labels:
  - "sablier.enable=true"
  - "sablier.group=my-service-group"
  - "sablier.start-on-demand=true"
  - "sablier.timeout=5m"  # Optional: per-service timeout
```

===== How Lazy Loading Works =====

**Request Flow:**
  1. **HTTP Request**: User accesses service URL
  2. **Traefik Routing**: Request hits Traefik with Sablier middleware
  3. **Sablier Check**: Sablier checks if target service is running
  4. **Container Start**: If stopped, Sablier starts the container
  5. **Health Wait**: Waits for service to be ready
  6. **Request Forward**: Forwards request to running service
  7. **Timeout Reset**: Resets inactivity timer

**Automatic Shutdown:**
  * **Inactivity Detection**: No requests for timeout period
  * **Graceful Shutdown**: Container stopped cleanly
  * **Resource Recovery**: CPU/memory freed up
  * **Restart Ready**: Ready for next access

===== Service Configuration =====

**Basic Setup:**
```yaml
services:
  my-service:
    image: my-service:latest
    labels:
      # Traefik labels (normal)
      - "traefik.enable=true"
      - "traefik.http.routers.my-service.rule=Host(`my-service.${DOMAIN}`)"
      - "traefik.http.routers.my-service.entrypoints=websecure"
      - "traefik.http.routers.my-service.tls.certresolver=letsencrypt"
      - "traefik.http.routers.my-service.middlewares=authelia@docker"
      
      # Sablier labels (lazy loading)
      - "sablier.enable=true"
      - "sablier.group=my-service"
      - "sablier.start-on-demand=true"
```

**Advanced Configuration:**
```yaml
labels:
  # Custom timeout (overrides global)
  - "sablier.timeout=10m"
  
  # Custom session duration
  - "sablier.session-duration=24h"
  
  # Group multiple services
  - "sablier.group=media-stack"
```

===== Timeout Management =====

**Global Timeout:**
```yaml
environment:
  - SABLIER_TIMEOUT=5m  # Default 5 minutes
```

**Per-Service Timeout:**
```yaml
labels:
  - "sablier.timeout=15m"  # Override for this service
```

**Session Duration:**
```yaml
environment:
  - SABLIER_SESSION_DURATION=168h  # 7 days default
```

**Timeout Behavior:**
  * **Activity Reset**: Each request resets the timer
  * **Graceful Shutdown**: Clean container stop
  * **Resource Recovery**: Memory/CPU freed
  * **Quick Restart**: Fast startup on next access

===== Group Management =====

**Service Groups:**
```yaml
# Related services in same group
services:
  sonarr:
    labels:
      - "sablier.group=media-management"
      
  radarr:
    labels:
      - "sablier.group=media-management"
      
  prowlarr:
    labels:
      - "sablier.group=media-management"
```

**Group Benefits:**
  * **Coordinated Startup**: Start related services together
  * **Shared Timeout**: Group timeout applies to all
  * **Resource Management**: Better resource planning
  * **Dependency Handling**: Handle service dependencies

===== Monitoring & Troubleshooting =====

**Sablier Logs:**
```bash
# View Sablier logs
docker logs sablier

# Follow logs in real-time
docker logs -f sablier
```

**Startup Monitoring:**
```bash
# Check service startup
docker logs sablier | grep "Starting container"

# Monitor shutdowns
docker logs sablier | grep "Stopping container"
```

**Debug Mode:**
```yaml
environment:
  - SABLIER_LOG_LEVEL=debug
```

**Common Issues:**

**Service Not Starting:**
```bash
# Check Sablier logs
docker logs sablier | grep -i "error\|failed"

# Verify Docker socket access
docker exec sablier ls -la /var/run/docker.sock

# Check network connectivity
docker exec sablier ping -c 2 traefik
```

**Timeout Issues:**
  * **Too Short**: Services stopping too quickly
  * **Too Long**: Resources not freed timely
  * **Per-Service**: Override global timeout
  * **Testing**: Monitor actual usage patterns

**Middleware Issues:**
  * **Traefik Config**: Verify middleware order
  * **Label Format**: Check label syntax
  * **Network Access**: Ensure Sablier can reach Docker API

**Troubleshooting Steps:**
  1. **Check logs**: `docker logs sablier`
  2. **Verify labels**: Check service configuration
  3. **Test startup**: Manual container start
  4. **Check network**: Verify Docker API access
  5. **Restart Sablier**: `docker restart sablier`

===== Performance Optimization =====

**Resource Limits:**
```yaml
deploy:
  resources:
    limits:
      cpus: '0.2'    # Low CPU usage
      memory: 128M   # Minimal memory
    reservations:
      cpus: '0.05'
      memory: 32M
```

**Timeout Tuning:**
  * **Frequent Access**: Longer timeouts (15-30m)
  * **Infrequent Access**: Shorter timeouts (2-5m)
  * **Resource Intensive**: Consider manual management
  * **User Patterns**: Monitor and adjust based on usage

**Startup Optimization:**
  * **Health Checks**: Fast health check endpoints
  * **Dependencies**: Minimize startup dependencies
  * **Caching**: Use persistent volumes for data
  * **Pre-warming**: Keep critical services running

===== Security Considerations =====

**Docker Socket Access:**
  * **Read-Only**: Mount socket as read-only
  * **Limited Access**: Only Sablier container access
  * **Network Isolation**: Separate network for Sablier
  * **Monitoring**: Monitor Docker API usage

**Service Security:**
  * **No Direct Access**: Services only accessible via Traefik
  * **Authentication**: Authelia protection maintained
  * **SSL**: HTTPS encryption preserved
  * **Timeout Security**: Automatic cleanup prevents exposure

===== Advanced Configuration =====

**Custom Strategies:**
```yaml
environment:
  - SABLIER_STRATEGY=docker-api  # Default
  # Alternative: kubernetes, swarm
```

**Queue Management:**
```yaml
environment:
  - SABLIER_QUEUE_SIZE=10  # Concurrent startups
  - SABLIER_QUEUE_TIMEOUT=30s  # Queue wait timeout
```

**Health Check Configuration:**
```yaml
environment:
  - SABLIER_HEALTH_CHECK=true
  - SABLIER_HEALTH_CHECK_TIMEOUT=30s
  - SABLIER_HEALTH_CHECK_INTERVAL=5s
```

**Dynamic Configuration:**
```yaml
# Via environment variables
environment:
  - SABLIER_SERVICES=my-service:5m,other-service:10m
```

===== Integration Examples =====

**Media Management Stack:**
```yaml
services:
  sonarr:
    labels:
      - "sablier.enable=true"
      - "sablier.group=media-mgmt"
      - "sablier.timeout=15m"
      
  radarr:
    labels:
      - "sablier.enable=true"
      - "sablier.group=media-mgmt"
      - "sablier.timeout=15m"
      
  prowlarr:
    labels:
      - "sablier.enable=true"
      - "sablier.group=media-mgmt"
      - "sablier.timeout=10m"
```

**Development Tools:**
```yaml
services:
  code-server:
    labels:
      - "sablier.enable=true"
      - "sablier.group=dev-tools"
      - "sablier.timeout=2h"  # Longer for development
      
  jupyter:
    labels:
      - "sablier.enable=true"
      - "sablier.group=dev-tools"
      - "sablier.timeout=1h"
```

===== Best Practices =====

**Service Selection:**
  * **Infrequently Used**: Perfect for rarely accessed services
  * **Resource Intensive**: Save resources on heavy services
  * **Development Tools**: Good for dev environments
  * **Always-On**: Keep critical services running

**Timeout Configuration:**
  * **Monitor Usage**: Track actual access patterns
  * **Adjust Gradually**: Start conservative, adjust based on logs
  * **Per-Service**: Different timeouts for different services
  * **User Feedback**: Consider user experience

**Resource Management:**
  * **Capacity Planning**: Calculate resource savings
  * **Monitoring**: Track startup/shutdown patterns
  * **Optimization**: Tune based on system resources
  * **Backup Plan**: Manual startup if needed

**Maintenance:**
  * **Log Review**: Regular log analysis
  * **Performance Monitoring**: Track resource usage
  * **Configuration Updates**: Update timeouts as needed
  * **Documentation**: Document lazy-loaded services

===== Monitoring & Alerts =====

**Log Analysis:**
```bash
# Startup events
docker logs sablier | grep "Starting"

# Shutdown events
docker logs sablier | grep "Stopping"

# Errors
docker logs sablier | grep -i "error"
```

**Performance Metrics:**
  * **Startup Time**: Time to service readiness
  * **Resource Usage**: CPU/memory before/after
  * **Access Patterns**: Frequency of service access
  * **Timeout Effectiveness**: Actual vs configured timeouts

**Health Monitoring:**
```yaml
# Add health check
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:10000/health"]
  interval: 30s
  timeout: 10s
  retries: 3
```

Sablier significantly reduces resource usage by keeping unused services stopped until needed, while maintaining a seamless user experience through automatic on-demand startup.

**Next:** Explore [[architecture:storage|Storage Architecture]] or return to [[services:start|Services Overview]].